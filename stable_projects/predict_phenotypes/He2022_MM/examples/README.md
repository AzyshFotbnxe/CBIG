# Code for Meta-matching examples

----

References
==========
+ He, T., An, L., Feng, J., Bzdok, D., Eickhoff, S.B. and Yeo, B.T., 2020. [**Meta-matching: a simple approach to leverage large-scale brain imaging datasets to boost prediction of non-imaging phenotypes in small datasets**](https://doi.org/10.1101/2020.08.10.245373), under review.

----

Usage
==========

1. Generate fake data
In this example, we use fake data generated by following code:
```bash
cd $CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/examples
python3 data_generate.py
```

2. Classical KRR
Run the classical KRR on one of fake phenotypes generated before with 20 shot:
```matlab
CBIG_CODE_DIR = getenv('CBIG_CODE_DIR');
base_dir = fullfile(CBIG_CODE_DIR, 'stable_projects', 'predict_phenotypes', 'He2022_MM');
example_dir = fullfile(base_dir, 'examples');
cd(example_dir)

code_dir = fullfile(base_dir, 'KRR_CLASSICAL');
input_dir = fullfile(example_dir, 'exp_input');
output_dir = fullfile(example_dir, 'exp_output', 'output_krr_classical');

subj_list = fullfile(input_dir, 'exp_test_subj_list.txt');
phe_csv = fullfile(input_dir, 'exp_test_final.csv');
FC_file = fullfile(input_dir, 'exp_test_pfc.mat');
phe = '108-888.0'; % one of dummy phenotype generated
k = '20';
rngs_num ='3'; % run the Classical KRR 3 times with 3 different split of 20 shot

addpath(code_dir);
CBIG_MM_KRR_classical(CBIG_CODE_DIR, subj_list, phe_csv, FC_file, output_dir, rngs_num, phe, k, false);
```
You can check the result you got against the result with the one in `exp_output` folder.

2. KRR Meta-matching
Run the KRR meta-matching by:
```matlab
CBIG_CODE_DIR = getenv('CBIG_CODE_DIR');
base_dir = fullfile(CBIG_CODE_DIR, 'stable_projects', 'predict_phenotypes', 'He2022_MM');
example_dir = fullfile(base_dir, 'examples');
cd(example_dir)

code_dir = fullfile(base_dir, 'KRR_MM');
input_dir = fullfile(example_dir, 'exp_input');
output_dir = fullfile(example_dir, 'exp_output', 'output_krr_MM');

phe_list= fullfile(input_dir, 'exp_train_final_phe_list.txt');
phe_csv= fullfile(input_dir, 'exp_train_test_final.csv');
subj_list= fullfile(input_dir, 'exp_train_test_subj_list.txt');
fc_mat= fullfile(input_dir, 'exp_train_test_pfc.mat');
subj_list_train= fullfile(input_dir, 'exp_train_subj_list.txt');
subj_list_extra= fullfile(input_dir, 'exp_test_subj_list.txt');

rngs_num = 3; % run the Classical KRR 3 times with 3 different split of 20 shot

addpath(code_dir);
for rng_num = 1:rngs_num
    CBIG_MM_KRR_MM_base(CBIG_CODE_DIR, subj_list, phe_csv, fc_mat, output_dir, num2str(rng_num), phe_list, subj_list_train, subj_list_extra);
end


```

After all jobs finished in previous part, run following code in matlab:
```matlab
cd $CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/replication
CBIG_MM_KRR_MM_summary(getenv('CBIG_CODE_DIR'))
```

3. Run DNN

The DNN meta-matching uses the split from KRR classical and meta-matching, if you want to run it, you need to run following command to get the split:
```bash
cd $CBIG_CODE_DIR/stable_projects/predict_phenotypes/He2022_MM/replication
python3 get_split.py
```

Run each python3 command in `CBIG_KRDNN_DNN_command.sh` from this `replication` folder (The hyperparameter in each python3 command are final hyperparameters for our results in our paper, tuned by hand-tuning (HCP dataset) and automatic hyperparameter tuning algorithm ([HORD](https://github.com/ilija139/HORD), UK Biobank dataset)). Since it takes a long time and you may need to choose which gpu to run the code on, it is better to run these commands individually. You can use the '--gpu' flag to choose which gpu in your machine to run the code.

4. Result reference

You can find my reference result in `CBIG_KRDNN_DNN_command.sh` for each command

----

Bugs and Questions
====
Please contact He Tong at hetong1115@gmail.com.
